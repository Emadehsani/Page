<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>لیست محصولات</title>
  <link rel="stylesheet" href="https://cdn.fontcdn.ir/Font/Vazir/Vazir.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Vazir', sans-serif; direction: rtl; padding: 30px; background: #f9f9f9; }
    h2 { margin-bottom: 20px; }
    .filters { margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
    .filter-row { display: flex; align-items: center; gap: 10px; }
    .filter-option { 
      display: inline-block; 
      padding: 5px 15px; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      margin: 3px; 
      cursor: pointer; 
      transition: 0.2s;
      background: white;
    }
    .filter-option.active { background: #007bff; color: white; border-color: #007bff; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    button { margin-bottom: 15px; padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
    #reset-btn { background: #dc3545; color: white; }
    #reset-btn:hover { background: #c82333; }
    #export-btn { background: #28a745; color: white; }
    #export-btn:hover { background: #218838; }
    .sub-filters { display: flex; gap: 5px; flex-wrap: wrap; }
    .separator { width: 1px; background: #ccc; margin: 0 8px; align-self: stretch; }
  </style>
</head>
<body>

<h2>📋 لیست محصولات</h2>

<button id="reset-btn">Reset Filters</button>
<button id="export-btn">DOWNLOAD</button>

<div class="filters" id="filter-category"></div>

<table id="product-table">
  <thead>
    <tr>
      <th>نام محصول</th>
      <th>قیمت عمومی</th>
      <th>قیمت دیجیتال</th>
      <th>قیمت زیر 1000</th>
      <th>قیمت کارتنی</th>
      <th>قیمت درب</th>
    </tr>
  </thead>
  <tbody id="product-list"></tbody>
</table>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTvY_Dh9wfH7UGfgFOzGhAKwl8nD4lFK9cCHFzTKiu7JfjuZ6QbGAuD_Z_6V9_B_VLvZo21V2kRU4VN/pub?output=csv";
let allData = [];
let activeFilters = { category: [], subcategory: [] };

function formatNumber(num) {
  if (!num || isNaN(Number(num)) || Number(num) === 0) return "";
  return Number(num).toLocaleString('fa-IR');
}

// تبدیل تاریخ میلادی به شمسی ساده
function getPersianDate() {
  const today = new Date();
  const persian = new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
    year: 'numeric', month: '2-digit', day: '2-digit'
  }).format(today);
  return persian;
}

fetch(sheetUrl)
  .then(res => res.text())
  .then(text => {
    const rows = text.split("\n").map(r => r.split(","));
    const headers = rows[0];
    const data = rows.slice(1).map(r => {
      let obj = {};
      headers.forEach((h,i) => obj[h.trim()] = r[i]);
      return obj;
    });
    allData = data;
    createFilters(allData);
    renderTable();
  });

function createFilters(data) {
  const container = document.getElementById("filter-category");
  container.innerHTML = "";

  let categories = [...new Set(data.map(d => d.category).filter(Boolean))];

  categories.forEach(cat => {
    const row = document.createElement("div");
    row.className = "filter-row";

    let btn = document.createElement("div");
    btn.className = "filter-option";
    btn.innerText = cat;
    if (activeFilters.category.includes(cat)) btn.classList.add("active");

    let subContainer = document.createElement("div");
    subContainer.className = "sub-filters";
    let subValues = [...new Set(data.filter(d => d.category===cat).map(d=>d.PPL).filter(Boolean))];

    if(subValues.length === 0){
      subContainer.style.display = "none";
    }

    let subButtons = [];
    subValues.forEach(sub => {
      let subBtn = document.createElement("div");
      subBtn.className = "filter-option";
      subBtn.innerText = sub;
      if (activeFilters.subcategory.includes(sub)) subBtn.classList.add("active");
      subBtn.onclick = (e) => {
        e.stopPropagation();
        if (activeFilters.subcategory.includes(sub)) {
          activeFilters.subcategory = activeFilters.subcategory.filter(x => x!==sub);
          subBtn.classList.remove("active");
        } else {
          activeFilters.subcategory.push(sub);
          subBtn.classList.add("active");
        }
        if (subValues.every(s => activeFilters.subcategory.includes(s))) {
          if (!activeFilters.category.includes(cat)) {
            activeFilters.category.push(cat);
            btn.classList.add("active");
          }
        } else {
          if (activeFilters.category.includes(cat)) {
            activeFilters.category = activeFilters.category.filter(x => x!==cat);
            btn.classList.remove("active");
          }
        }
        renderTable();
      };
      subContainer.appendChild(subBtn);
      subButtons.push(subBtn);
    });
    if(subValues.length > 0){
      subContainer.style.display = "flex";
    }

    btn.onclick = () => {
      if (activeFilters.category.includes(cat)) {
        activeFilters.category = activeFilters.category.filter(x => x!==cat);
        btn.classList.remove("active");
        subValues.forEach((sub, i) => {
          activeFilters.subcategory = activeFilters.subcategory.filter(x => x!==sub);
          subButtons[i].classList.remove("active");
        });
      } else {
        activeFilters.category.push(cat);
        btn.classList.add("active");
        subValues.forEach((sub, i) => {
          if (!activeFilters.subcategory.includes(sub)) activeFilters.subcategory.push(sub);
          subButtons[i].classList.add("active");
        });
      }
      renderTable();
    };

    row.appendChild(btn);

    const separator = document.createElement("div");
    separator.className = "separator";
    row.appendChild(separator);

    row.appendChild(subContainer);
    container.appendChild(row);
  });
}

function renderTable() {
  const tbody = document.getElementById("product-list");
  tbody.innerHTML = "";

  let filtered = allData.filter(item => {
    let catMatch = activeFilters.category.length===0 || activeFilters.category.includes(item.category);
    let subMatch = activeFilters.subcategory.length===0 || activeFilters.subcategory.includes(item.PPL);
    return catMatch && subMatch;
  });

  filtered.forEach(item => {
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name || ""}</td>
      <td>${formatNumber(item.price_omomi)}</td>
      <td>${formatNumber(item.price_digital)}</td>
      <td>${formatNumber(item.price_1000)}</td>
      <td>${formatNumber(item.price_box)}</td>
      <td>${formatNumber(item.door)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// دکمه خروجی PDF حرفه‌ای با jsPDF
document.getElementById("export-btn").onclick = () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation: "landscape"});

  // تنظیم فونت و اندازه
  pdf.setFontSize(22);
  pdf.text("لیست قیمت محصولات", pdf.internal.pageSize.getWidth()/2, 15, {align: "center"});
  pdf.setFontSize(16);
  pdf.text(getPersianDate(), pdf.internal.pageSize.getWidth()/2, 25, {align: "center"});
  pdf.setFontSize(14);
  pdf.text("اعتبار این لیست قیمت فقط 24 ساعت می باشد", pdf.internal.pageSize.getWidth()/2, 32, {align: "center"});

  // جدول
  const startY = 40;
  const rowHeight = 10;
  const colWidths = [50, 35, 35, 35, 35, 35]; // عرض ستون‌ها
  const headers = ["نام محصول","قیمت عمومی","قیمت دیجیتال","قیمت زیر 1000","قیمت کارتنی","قیمت درب"];
  let x = 10;
  let y = startY;

  // چاپ هدر جدول
  pdf.setFontSize(12);
  headers.forEach((h, i) => {
    pdf.rect(x, y, colWidths[i], rowHeight);
    pdf.text(h, x + colWidths[i]/2, y + 7, {align: "center"});
    x += colWidths[i];
  });

  // چاپ ردیف‌ها
  y += rowHeight;
  allData.filter(item => {
    let catMatch = activeFilters.category.length===0 || activeFilters.category.includes(item.category);
    let subMatch = activeFilters.subcategory.length===0 || activeFilters.subcategory.includes(item.PPL);
    return catMatch && subMatch;
  }).forEach(item => {
    x = 10;
    const row = [
      item.name || "",
      formatNumber(item.price_omomi),
      formatNumber(item.price_digital),
      formatNumber(item.price_1000),
      formatNumber(item.price_box),
      formatNumber(item.door)
    ];
    row.forEach((cell, i) => {
      pdf.rect(x, y, colWidths[i], rowHeight);
      pdf.text(cell.toString(), x + colWidths[i]/2, y + 7, {align: "center"});
      x += colWidths[i];
    });
    y += rowHeight;
    if(y + rowHeight > pdf.internal.pageSize.getHeight() - 20){
      pdf.addPage();
      y = startY;
    }
  });

  // متن پایین
  pdf.setFontSize(12);
  pdf.text("جهت استعلام قیمت به روز با این شماره تماس بگیرید 09120836625 غلامی", pdf.internal.pageSize.getWidth()/2, pdf.internal.pageSize.getHeight() - 10, {align: "center"});

  pdf.save("table.pdf");
};

document.getElementById("reset-btn").onclick = () => {
  activeFilters = { category: [], subcategory: [] };
  createFilters(allData);
  renderTable();
};
</script>

</body>
</html>
