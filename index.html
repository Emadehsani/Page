<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</title>
<link rel="stylesheet" href="https://cdn.fontcdn.ir/Font/Vazir/Vazir.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: 'Vazir', sans-serif; direction: rtl; padding: 10px; background: #f9f9f9; }
h2 { margin-bottom: 20px; }
.filters { margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
.filter-row { display: flex; align-items: center; gap: 10px; }
.filter-option { display: inline-block; padding: 5px 15px; border: 1px solid #ccc; border-radius: 8px; margin: 3px; cursor: pointer; transition: 0.2s; background: white; }
.filter-option.active { background: #007bff; color: white; border-color: #007bff; }
table { border-collapse: collapse; margin-top: 20px; background: white; font-size: 18px; }
th, td { border: 1px solid #ccc; padding: 10px; text-align: center; white-space: nowrap; }
th { background: #f0f0f0; }
button { margin-bottom: 15px; padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
#reset-btn { background: #dc3545; color: white; }
#reset-btn:hover { background: #c82333; }
#export-pdf-btn { background: #28a745; color: white; margin-left: 10px; }
#export-pdf-btn:hover { background: #218838; }
#export-png-btn { background: #007bff; color: white; }
#export-png-btn:hover { background: #0069d9; }
.sub-filters { display: flex; gap: 5px; flex-wrap: wrap; }
.separator { width: 1px; background: #ccc; margin: 0 8px; align-self: stretch; }
.button-group { display: flex; gap: 10px; margin-bottom: 15px; }
</style>
</head>
<body>

<h2>ðŸ“‹ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</h2>

<div class="button-group">
  <button id="reset-btn">Reset Filters</button>
  <button id="export-pdf-btn">DOWNLOAD PDF</button>
  <button id="export-png-btn">DOWNLOAD PNG</button>
</div>

<div class="filters" id="filter-category"></div>

<table id="product-table">
  <thead>
    <tr>
      <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>
      <th>Ù‚ÛŒÙ…Øª Ø¹Ù…ÙˆÙ…ÛŒ</th>
      <th>Ù‚ÛŒÙ…Øª Ø¯ÛŒØ¬ÛŒØªØ§Ù„</th>
      <th>Ù‚ÛŒÙ…Øª Ø²ÛŒØ± 1000</th>
      <th>Ù‚ÛŒÙ…Øª Ú©Ø§Ø±ØªÙ†ÛŒ</th>
      <th>Ù‚ÛŒÙ…Øª Ø¯Ø±Ø¨</th>
    </tr>
  </thead>
  <tbody id="product-list"></tbody>
</table>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTvY_Dh9wfH7UGfgFOzGhAKwl8nD4lFK9cCHFzTKiu7JfjuZ6QbGAuD_Z_6V9_B_VLvZo21V2kRU4VN/pub?output=csv";
let allData = [];
let activeFilters = { category: [], subcategory: [] };

function formatNumber(num) {
  if (!num || isNaN(Number(num)) || Number(num) === 0) return "";
  return Number(num).toLocaleString('fa-IR');
}

// Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
fetch(sheetUrl)
.then(res => res.text())
.then(text => {
  const rows = text.split("\n").map(r => r.split(","));
  const headers = rows[0];
  const data = rows.slice(1).map(r => {
    let obj = {};
    headers.forEach((h,i) => obj[h.trim()] = r[i]);
    return obj;
  });
  allData = data;
  createFilters(allData);
  renderTable();
});

// Ø§ÛŒØ¬Ø§Ø¯ ÙÛŒÙ„ØªØ±Ù‡Ø§
function createFilters(data) {
  const container = document.getElementById("filter-category");
  container.innerHTML = "";
  let categories = [...new Set(data.map(d => d.category).filter(Boolean))];

  categories.forEach(cat => {
    const row = document.createElement("div");
    row.className = "filter-row";

    let btn = document.createElement("div");
    btn.className = "filter-option";
    btn.innerText = cat;
    if (activeFilters.category.includes(cat)) btn.classList.add("active");

    let subContainer = document.createElement("div");
    subContainer.className = "sub-filters";
    let subValues = [...new Set(data.filter(d => d.category===cat).map(d=>d.PPL).filter(Boolean))];

    if(subValues.length === 0){ subContainer.style.display = "none"; }

    let subButtons = [];
    subValues.forEach(sub => {
      let subBtn = document.createElement("div");
      subBtn.className = "filter-option";
      subBtn.innerText = sub;
      if (activeFilters.subcategory.includes(sub)) subBtn.classList.add("active");
      subBtn.onclick = (e) => {
        e.stopPropagation();
        if (activeFilters.subcategory.includes(sub)) {
          activeFilters.subcategory = activeFilters.subcategory.filter(x => x!==sub);
          subBtn.classList.remove("active");
        } else {
          activeFilters.subcategory.push(sub);
          subBtn.classList.add("active");
        }
        if (subValues.every(s => activeFilters.subcategory.includes(s))) {
          if (!activeFilters.category.includes(cat)) {
            activeFilters.category.push(cat);
            btn.classList.add("active");
          }
        } else {
          if (activeFilters.category.includes(cat)) {
            activeFilters.category = activeFilters.category.filter(x => x!==cat);
            btn.classList.remove("active");
          }
        }
        renderTable();
      };
      subContainer.appendChild(subBtn);
      subButtons.push(subBtn);
    });
    if(subValues.length > 0){ subContainer.style.display = "flex"; }

    btn.onclick = () => {
      if (activeFilters.category.includes(cat)) {
        activeFilters.category = activeFilters.category.filter(x => x!==cat);
        btn.classList.remove("active");
        subValues.forEach((sub, i) => {
          activeFilters.subcategory = activeFilters.subcategory.filter(x => x!==sub);
          subButtons[i].classList.remove("active");
        });
      } else {
        activeFilters.category.push(cat);
        btn.classList.add("active");
        subValues.forEach((sub, i) => {
          if (!activeFilters.subcategory.includes(sub)) activeFilters.subcategory.push(sub);
          subButtons[i].classList.add("active");
        });
      }
      renderTable();
    };

    row.appendChild(btn);
    const separator = document.createElement("div");
    separator.className = "separator";
    row.appendChild(separator);
    row.appendChild(subContainer);
    container.appendChild(row);
  });
}

// Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„
function renderTable() {
  const tbody = document.getElementById("product-list");
  tbody.innerHTML = "";

  let filtered = allData.filter(item => {
    let catMatch = activeFilters.category.length===0 || activeFilters.category.includes(item.category);
    let subMatch = activeFilters.subcategory.length===0 || activeFilters.subcategory.includes(item.PPL);
    return catMatch && subMatch;
  });

  filtered.forEach(item => {
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name || ""}</td>
      <td>${formatNumber(item.price_omomi)}</td>
      <td>${formatNumber(item.price_digital)}</td>
      <td>${formatNumber(item.price_1000)}</td>
      <td>${formatNumber(item.price_box)}</td>
      <td>${formatNumber(item.door)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¹Ø±Ø¶ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø¨Ø§ Ø·ÙˆÙ„ Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ù…ØªÙ†
function getColumnWidths(table) {
  const ctx = document.createElement("canvas").getContext("2d");
  ctx.font = "18px Vazir";
  const widths = [];
  const rows = Array.from(table.rows);
  const colsCount = rows[0].cells.length;

  for(let c=0; c<colsCount; c++){
    let maxWidth = 0;
    rows.forEach(row=>{
      const text = row.cells[c].innerText;
      const w = ctx.measureText(text).width + 20; // padding
      if(w>maxWidth) maxWidth=w;
    });
    widths.push(maxWidth);
  }
  return widths;
}

// Ø®Ø±ÙˆØ¬ÛŒ PNG
document.getElementById("export-png-btn").onclick = () => {
  const table = document.getElementById("product-table");
  const widths = getColumnWidths(table);

  html2canvas(table, {scale:2}).then(canvas => {
    const link = document.createElement("a");
    link.download = 'table.png';
    link.href = canvas.toDataURL();
    link.click();
  });
};

// Ø®Ø±ÙˆØ¬ÛŒ PDF
document.getElementById("export-pdf-btn").onclick = () => {
  const table = document.getElementById("product-table");
  html2canvas(table, {scale:2}).then(canvas => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation: 'portrait', unit:'px', format:[1080,1920]});
    const imgData = canvas.toDataURL("image/png");
    const imgProps = pdf.getImageProperties(imgData);
    const pageHeight = 1920;
    const imgHeight = (imgProps.height * 1080) / imgProps.width;

    let position = 0;
    while(position < imgHeight){
      pdf.addImage(imgData, 'PNG', 0, -position, 1080, imgHeight);
      position += pageHeight;
      if(position < imgHeight) pdf.addPage();
    }
    pdf.save('table.pdf');
  });
};

// Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª
document.getElementById("reset-btn").onclick = () => {
  activeFilters = { category: [], subcategory: [] };
  createFilters(allData);
  renderTable();
};
</script>

</body>
</html>
